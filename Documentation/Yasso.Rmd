---
title: "Yasso"
author: "Lorenzo Menichetti"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: true
    theme: flatly
    highlight: tango
    code_folding: show
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(tidyverse)
library(knitr)
library(kableExtra)
```

# Yasso model family documentation (Yasso07, Yasso15, Yasso20)

## Overview

The **Yasso** family of soil organic carbon (SOC) models describes litter decomposition using a **chemical fractionation** approach based on the **AWENH** pool structure. All variants used here are **linear compartment models** with climate modifiers and (optionally) woody size effects, solved with a matrix exponential for annual time steps.

This document describes:
- **Yasso07**: classic AWENH model with annual mean temperature + amplitude and annual precipitation drivers.
- **Yasso15**: updated parameterization and fraction-specific climate sensitivities (still annual drivers).
- **Yasso20**: updated model that uses **monthly temperature forcing** (12-month vector) plus **annual precipitation**.

---

## Comparison table (quick reference)

```{r yasso-comparison-table}
yasso_comp <- tibble::tribble(
  ~Model, ~Pools, ~Time_step, ~Climate_forcing, ~Precipitation_use, ~Temp_use, ~Woody_size, ~Typical_initialization,
  "Yasso07", "AWENH (5)", "Annual", "Annual mean T + amplitude; annual P", "Annual scalar", "4-point approx using mean+amplitude", "Yes (applied in implementation via size modifier)", "Analytical steady state (A x + b = 0) per litter type",
  "Yasso15", "AWENH (5)", "Annual", "Annual mean T + amplitude; annual P", "Annual scalar (fraction-specific gamma)", "4-point approx; fraction-specific betas (AWE/N/H)", "Yes (size modifier)", "Analytical steady state (A x + b = 0) per litter type",
  "Yasso20", "AWENH (5)", "Annual (model step)", "Monthly T (12 values) + annual P", "Annual scalar (plus optional leaching term)", "Mean of exp(beta1*T + beta2*T^2) over months (fraction-specific)", "Yes (size modifier)", "Analytical steady state (A x + b = 0) per litter type (spinup/SS_pred)"
)

kable(yasso_comp, format = "html", caption = "Table 1. Comparison of Yasso variants used in the wrapper.") %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped","hover")) %>%
  column_spec(1, width = "7em") %>%
  column_spec(4, width = "20em") %>%
  column_spec(8, width = "20em")
```

---

# Yasso07

## Overview

**Yasso07** is a chemical fractionation model for SOC decomposition based on the **AWENH** pool structure. It supports multiple litter types with different wood sizes and uses **annual** time steps.

**Key features:**
- Chemical fractionation (AWEN + Humus pools)
- Three litter types: non-woody (nwl), fine woody (fwl), coarse woody (cwl)
- Wood size effects on decomposition
- Temperature and precipitation modifiers
- Matrix exponential solution for accurate annual integration

**Reference:** Tuomi et al. (2009). *Ecological Modelling*, 220, 3362–3371.

---

## Model structure

### Chemical pools

Yasso07 tracks five organic matter pools:

1. **A (Acid-soluble)**
2. **W (Water-soluble)**
3. **E (Ethanol-soluble)**
4. **N (Neither-soluble)**
5. **H (Humus)**

### Litter type classification

| Litter Type | Diameter | Components |
|-------------|----------|------------|
| **nwl** | 0 cm | Foliage, fine roots, understorey |
| **fwl** | 2 cm | Small branches |
| **cwl** | 15 cm | Large branches, stems, coarse roots |

### Mathematical formulation

Continuous-time compartment model:

$$\frac{d\mathbf{C}}{dt} = \mathbf{A} \mathbf{C} + \mathbf{I}$$

with $\mathbf{C}=[C_A,C_W,C_E,C_N,C_H]^T$ and $\mathbf{I}=[I_A,I_W,I_E,I_N,0]^T$.

Annual update ($\Delta t = 1$):

$$\mathbf{C}(t+1) = e^{\mathbf{A}} \mathbf{C}(t) + (e^{\mathbf{A}} - \mathbf{I}_5)\, \mathbf{A}^{-1} \mathbf{I}$$

Respiration by mass balance:

$$R_h(t)=\sum C(t) + \sum I(t) - \sum C(t+1)$$

---

## Environmental modifiers

### Temperature modifier (mean + amplitude)

Yasso07 uses a four-point approximation for seasonal temperature dependence:

$$f_{temp} = \frac{1}{4} \sum_{i=1}^{4} \exp(\beta_1 T_i + \beta_2 T_i^2)$$

where $T_i$ are quarterly temperatures derived from annual mean $\bar{T}$ and amplitude $A$.

### Precipitation modifier

$$f_{precip} = 1 - \exp\left(\gamma \cdot \frac{P}{1000}\right)$$

### Wood size modifier

A size modifier slows decomposition for woody litter:

$$f_{size} = \min\left(1, \exp\left(-\delta_1 d^{\delta_2} |r|\right)\right)$$

In the implementation, size is applied through a size modifier term when building $\mathbf{A}$ for each litter type.

---

## Initialization

### Analytical steady-state (recommended)

In the wrapper implementation, the default steady state for each litter type is computed analytically under **mean climate** and **mean annual inputs**:

$$\mathbf{C}_{ss} = -\mathbf{A}^{-1}\mathbf{I}$$

This corresponds to equilibrium under stationary forcing and avoids long numerical spinups.

---

# Yasso15

## Overview

**Yasso15** retains the same AWENH structure and annual integration approach as Yasso07, but uses updated parameterization and allows **fraction-specific climate sensitivities**:

- Separate temperature response parameters for **AWE**, **N**, and **H**
- Separate precipitation response parameters for **AWE**, **N**, and **H**
- Same three litter types (nwl/fwl/cwl) with wood size effects (via a size modifier)

Practically, Yasso15 is often used when one wants a more flexible climate response than Yasso07 while keeping the same pool structure and annual timestep.

---

## Climate forcing

Yasso15 uses the same annual climate summaries as Yasso07:
- `temp_mean` (annual mean temperature)
- `temp_amplitude` (annual temperature amplitude)
- `precip` (annual precipitation total)

Temperature dependence is computed using a four-point approximation (same structure as Yasso07), but with separate parameters:
- $(\beta_1,\beta_2)$ for A/W/E
- $(\beta_{N1},\beta_{N2})$ for N
- $(\beta_{H1},\beta_{H2})$ for H

Precipitation dependence is also fraction-specific:
- $\gamma$ (A/W/E), $\gamma_N$ (N), $\gamma_H$ (H)

---

## Mathematical structure

Same linear ODE form:

$$\frac{d\mathbf{C}}{dt} = \mathbf{A}(\text{climate}, d)\, \mathbf{C} + \mathbf{I}$$

but with fraction-specific scaling in $\mathbf{A}$. Annual update is again based on the matrix exponential.

---

## Initialization

In the current framework, Yasso15 uses **analytical steady state** per litter type (nwl/fwl/cwl) under mean climate and mean litter input:

$$\mathbf{C}_{ss} = -\mathbf{A}^{-1}\mathbf{I}$$

The total site SOC trajectory is obtained by summing the litter-type trajectories because the system is linear and litter types are simulated independently.

---

# Yasso20

## Overview

**Yasso20** uses the same AWENH pool structure and annual model step, but differs in climate forcing:

- **Monthly temperatures** (vector of length 12) are used directly in the temperature response.
- **Precipitation is an annual scalar** (as in the original Yasso20 interface).
- Fraction-specific temperature and precipitation sensitivities (AWE vs N vs H), similar in spirit to Yasso15 but with monthly-T evaluation.

This makes Yasso20 the most suitable Yasso variant in the framework when monthly temperature forcing is available and you want to avoid reducing temperature forcing to mean + amplitude.

---

## Climate forcing

Inputs required (per year):
- Monthly temperature vector: $T_1, \ldots, T_{12}$
- Annual precipitation total: $P$

Temperature dependence is computed as an average over months:

$$tem = \frac{1}{12}\sum_{m=1}^{12} \exp(\beta_1 T_m + \beta_2 T_m^2)$$

and similarly for N and H with $(\beta_{N1},\beta_{N2})$, $(\beta_{H1},\beta_{H2})$.

Precipitation scaling uses the same saturating function form as Yasso07/15 but with fraction-specific parameters.

> **Important:** Yasso20 (as implemented from the original function signature) does **not** use monthly precipitation values month-by-month; precipitation enters as an **annual** scalar.

---

## Mathematical structure

Same linear ODE form, with $\mathbf{A}$ constructed using monthly-temperature-based modifiers and annual precipitation:

$$\frac{d\mathbf{C}}{dt} = \mathbf{A}(T_{1..12}, P, d)\, \mathbf{C} + \mathbf{I}$$

Annual update is solved analytically (matrix exponential).

---

## Initialization

Yasso20 supports analytical steady-state initialization via the original “steady state prediction” option (SS_pred/spinup):

$$\mathbf{C}_{ss} = -\mathbf{A}^{-1}\mathbf{I}$$

In the wrapper, Yasso20 is initialized analytically per litter type when `C0 = NULL` and `spinup = TRUE`.

---

# Practical notes for intercomparison

## What is consistent across Yasso variants here?
- Same pool structure: AWENH
- Same litter-type separation: nwl/fwl/cwl (different wood sizes)
- Linear dynamics with matrix-exponential annual integration
- Outputs: pool trajectories + total SOC + respiration (mass balance)

## Main differences that matter
- **Temperature forcing resolution**
  - Yasso07/15: annual mean + amplitude
  - Yasso20: monthly temperatures
- **Climate sensitivity flexibility**
  - Yasso07: shared temperature & precipitation sensitivity across pools (in typical use)
  - Yasso15/20: fraction-specific climate sensitivity (AWE vs N vs H)
- **Precipitation handling**
  - all variants here use precipitation as an annual scalar; RothC (outside Yasso) is the one using monthly moisture balance in your framework

---

## References

- Tuomi, M., Thum, T., Järvinen, H., et al. (2009). *Ecological Modelling*, 220, 3362–3371.
- Liski, J., Palosuo, T., Peltoniemi, M., & Sievänen, R. (2005). *Ecological Modelling*, 189, 168–182.
- Tuomi, M., Laiho, R., Repo, A., & Liski, J. (2011). *Ecological Modelling*, 222, 709–718.
